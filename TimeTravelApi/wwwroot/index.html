<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Time Machine FTW!!!</title>
    <style>
        body { 
            margin:0;  
        }

        svg {
          display:block; position:absolute;
          top:50px; left:300px; width:100%; height:100%;
        }
		
        input[type='submit'], button, [aria-label] {
            cursor: pointer;
        }

        #spoiler {
            display: none;
        }

        table {
            font-family: Arial, sans-serif;
            border: 1px solid;
            border-collapse: collapse;
        }

        th {
            background-color: #0066CC;
            color: white;
        }

        td {
            border: 1px solid;
            padding: 5px;
        }
    </style>
</head>
<body>

    <h1>Time Machine FTW!!!</h1>

    <!-- Tardis image -->
    <img width="162" height="312" style="margin-top: 56px;" src="tardis.png" alt="tardis!!!">


    <table>
        <tr>
            <th>Expired</th>
            <th>Start Time</th>
            <th></th>
            <th></th>
        </tr>
        <tbody id="timerequests"></tbody>
    </table>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js"
            integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
            crossorigin="anonymous"></script>
    <script src="site.js"></script>
	
    
  <script src="https://www.puck-js.com/puck.js"></script>
  <script type="text/javascript">
    var img = document.getElementsByTagName('img')[0];

    // Make sure your mouse cursor turns into a hand when over the tardis, and gray it out
    img.style="cursor:pointer;fill:#BBB";

    // Called when we get a line of data - this might mean the button has been clicked
    function onLine(v) {
      if (v.includes("click\r")) {
        console.log("BUTTON CLICKED");
        addTimeRequest();
      }
    }

    // When clicked, connect or disconnect
    var connection;
    var startedChecking = false;
    img.addEventListener("click", function() {
      if (connection) {
        connection.close();
        connection = undefined;
      }
      Puck.connect(function(c) {
        // Start polling immediately for alerts, even if there is no Puck connection.
        connection = c;
        if (!startedChecking) {
            checkForAlert(connection);
            startedChecking = true;
        } else {            
            console.log("Not checking for alerts any more cos already doing that!!");
        }
        
        if (!c) {
          console.log("Couldn't connect to puck! Adding time request instead.");
          addTimeRequest();
          return;
        }

        // Handle the data we get back, and call 'onLine'
        // whenever we get a line
        var buf = "";
        connection.on("data", function(d) {
          buf += d;
          var i = buf.indexOf("\n");
          while (i>=0) {
            onLine(buf.substr(0,i));
            buf = buf.substr(i+1);
            i = buf.indexOf("\n");
          }
        });
        // First, reset Puck.js
        connection.write("reset();\n", function() {
          // Wait for it to reset itself
          setTimeout(function() {
            // Now tell it to set up an event handler which will send back a 'click' 
            // message whenever the puck button is clicked
            connection.write("setWatch(function(e) {Bluetooth.println('click');LED2.set();setTimeout(function(){LED2.reset();},500);}, BTN, {edge:'falling', debounce:50, repeat:true});\n",
              function() { console.log("Ready..."); });
          }, 1500);
        });
      });
    });
  </script>
</body>
</html>