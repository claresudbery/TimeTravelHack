<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Time Machine FTW!!!</title>
	<style>
		@import url('https://fonts.googleapis.com/css?family=Chakra+Petch');

    body {
      font-family: 'Chakra Petch', sans-serif;
    }
		h1 {
			font-size: 3em;
		}

		body {
			margin: 0;
		}

		svg {
			display: block;
			position: absolute;
			top: 50px;
			left: 300px;
			width: 100%;
			height: 100%;
		}

		input[type='submit'], button, [aria-label] {
			cursor: pointer;
		}

		#spoiler {
			display: none;
		}

		table {
			font-family: Arial, sans-serif;
			border: 1px solid;
			border-collapse: collapse;
		}

		th {
			background-color: #0066CC;
			color: white;
		}

		td {
			border: 1px solid;
			padding: 5px;
		}

		.clock {
			font-size: 4em;
		}
	</style>
</head>
<body>
	<div align="center">

		<h1>Time Machine FTW!!!</h1>

		<!-- Tardis image -->
		<img width="162" height="312" style="margin-top: 56px; padding-bottom: 40px;" src="tardis.png" alt="tardis!!!">

		<div class="clock"></div>

		<form class="timeInputInMinutes">
			<span>How much time do you need?</span>
			<span><input type="number" name="RequestedTimeInMinutes" placeholder="value in minutes e.g. 20"/></span>
		</form>

		<table>
			<tr>
				<th>Expired</th>
				<th>Start Time</th>
				<th>Length</th>
				<th>User Id</th>
				<th></th>
				<th></th>
			</tr>
			<tbody id="timerequests"></tbody>
		</table>

		<script src="https://code.jquery.com/jquery-3.3.1.min.js"
				integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
				crossorigin="anonymous"></script>
		<script src="site.js"></script>


		<script src="https://www.puck-js.com/puck.js"></script>
		<script type="text/javascript">
    function uuidv4() {
        return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
            (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
        )
    }

    var img = document.getElementsByTagName('img')[0];

    // Make sure your mouse cursor turns into a hand when over the tardis, and gray it out
    img.style="cursor:pointer;fill:#BBB";

    var uniqueId = uuidv4();
    console.log("new id: " + uniqueId);

    // Called when we get a line of data - this might mean the button has been clicked
    function onLine(v) {
      if (v.includes("click\r")) {
        console.log("BUTTON CLICKED");
        addTimeRequest(uniqueId);
      }
    }

    // When clicked, connect or disconnect
    var connection;
    var startedChecking = false;
    img.addEventListener("click", function() {
      if (connection) {
        connection.close();
        connection = undefined;
      }
      Puck.connect(function(c) {
        // Start polling immediately for alerts, even if there is no Puck connection.
        connection = c;
        if (connection) {
            uniqueId = uuidv4();
            console.log("new id: " + uniqueId);
        }
        if (!startedChecking) {
            checkForAlert(connection, uniqueId);
            startedChecking = true;
        } else {
            console.log("Not checking for alerts any more cos already doing that!!");
        }

        if (!c) {
          console.log("Couldn't connect to puck! Adding time request instead.");
          addTimeRequest(uniqueId);
          return;
        }

        // Handle the data we get back, and call 'onLine'
        // whenever we get a line
        var buf = "";
        connection.on("data", function(d) {
          buf += d;
          var i = buf.indexOf("\n");
          while (i>=0) {
            onLine(buf.substr(0,i));
            buf = buf.substr(i+1);
            i = buf.indexOf("\n");
          }
        });
        // First, reset Puck.js
        connection.write("reset();\n", function() {
          // Wait for it to reset itself
          setTimeout(function() {
            // Now tell it to set up an event handler which will send back a 'click'
            // message whenever the puck button is clicked
            connection.write("setWatch(function(e) {Bluetooth.println('click');LED2.set();setTimeout(function(){LED2.reset();},500);}, BTN, {edge:'falling', debounce:50, repeat:true});\n",
              function() { console.log("Ready..."); });
          }, 1500);
        });
      });
    });
		</script>
	</div>
</body>
</html>
