<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Time Machine FTW!!!</title>
	<style>
		@import url('https://fonts.googleapis.com/css?family=Chakra+Petch');

    body {
      font-family: 'Chakra Petch', sans-serif;
    }
		h1 {
			font-size: 3em;
		}

		body {
			margin: 0;
		}

		svg {
			display: block;
			position: absolute;
			top: 50px;
			left: 300px;
			width: 100%;
			height: 100%;
		}

		input[type='submit'], button, [aria-label] {
			cursor: pointer;
		}

		table {
			font-family: Arial, sans-serif;
			border: 1px solid;
			border-collapse: collapse;
		}

		th {
			background-color: #0066CC;
			color: white;
		}

		td {
			border: 1px solid;
			padding: 5px;
		}

		.clock {
			font-size: 4em;
		}
	</style>
</head>
<body>
	<div align="center">

		<h1>Time Machine FTW!!!</h1>

		<!-- Tardis image -->
		<img width="162" height="312" style="margin-top: 56px;" src="tardis.png" alt="tardis!!!">

    <div class="clock"></div>
    
    <br/>
    <span>Please click on the tardis to start.</span>
    <br/>
    <br/>

		<form class="timeInputInMinutes">
			<span>How much time do you need?</span>
			<span><input type="number" value="20" name="RequestedTimeInMinutes" placeholder="value in minutes e.g. 20"/></span>
		</form>
    <br/>

		<table>
			<tr>
				<th>Expired</th>
				<th>Start Time</th>
				<th>Length</th>
				<th>User Id</th>
				<th></th>
				<th></th>
			</tr>
			<tbody id="timerequests"></tbody>
		</table>

		<script src="https://code.jquery.com/jquery-3.3.1.min.js"
				integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
				crossorigin="anonymous"></script>
		<script src="site.js"></script>


		<script src="https://www.puck-js.com/puck.js"></script>
		<script type="text/javascript">
    var puckConnection = null;
    var workingWithoutPuck = false;
    var connection;

    // Make sure your mouse cursor turns into a hand when over the tardis, and gray it out
    var img = document.getElementsByTagName('img')[0];
    img.style="cursor:pointer;fill:#BBB";
    
    function uuidv4() {
        return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
            (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
        )
    }

    // Called when we get a line of data - this might mean the button has been clicked
    function onLine(v) {
      if (v.includes("click\r")) {
        console.log("BUTTON CLICKED");
        addTimeRequest(uniqueId);
      }
    }

    function handleNoPuckConnection() {   
      if (confirm("Couldn't connect to puck! Would you like to add a time request every time you click on the tardis?")) {
        var uniqueId = uuidv4();
        console.log("new id: " + uniqueId);
        addTimeRequest(uniqueId);
        workingWithoutPuck = true;
      }
    }

    function handleDataFromPuck() {      
      // Handle the data we get back, and call 'onLine'
      // whenever we get a line
      var buf = "";
      puckConnection.on("data", function(d) {
        buf += d;
        var i = buf.indexOf("\n");
        while (i>=0) {
          onLine(buf.substr(0,i));
          buf = buf.substr(i+1);
          i = buf.indexOf("\n");
        }
      });
    }

    function setupPuckEvents() {
      // First, reset Puck.js
      puckConnection.write("reset();\n", function() {
        // Wait for it to reset itself
        setTimeout(function() {
          // Now tell it to set up an event handler which will send back a 'click'
          // message whenever the puck button is clicked
          puckConnection.write("setWatch(function(e) {Bluetooth.println('click');LED2.set();setTimeout(function(){LED2.reset();},500);}, BTN, {edge:'falling', debounce:50, repeat:true});\n",
            function() { console.log("Ready..."); });
        }, 1500);
      });
    }

    function createPuckConnection() {      
        Puck.connect(function(c) {
          puckConnection = c;
          if (puckConnection) {
              uniqueId = uuidv4();
              console.log("new id: " + uniqueId);
          }

          if (!puckConnection) {
            handleNoPuckConnection();
          } else {
            handleDataFromPuck();
            setupPuckEvents();
          }
        });
    }

    // When clicked, connect or disconnect
    img.addEventListener("click", function() {
      if (connection) {
        connection.close();
        connection = undefined;
      }

      if (workingWithoutPuck) {
        addTimeRequest(uniqueId);
      } else {
        createPuckConnection();
      }
    });
		</script>
	</div>
</body>
</html>
